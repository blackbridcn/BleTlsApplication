



1 协议数据包的基本格式:

序号	 1	     2	     3      4	    5
内容	起始符	命令符	长度	   数据位	校验位
字节 1	    1	     2	    n	     2
说明	0x7E	xx	    xxxx	xxxx	xxxx
注意：
1．定义系统特殊字：0x7E
凡是蓝色部分数据出现系统特殊字做特殊处理：1byte扩展为2byte.
   0x7E0xE7, 0x58;
[起始字]
1Byte，固定的 0x7E
[命令]
1Byte
[长度]
2个字节，起始符开始（不包括起始符），截止消息体（包括消息体）
即：长度=（命令符+长度+数据位）长度
[CRC校验]
2Byte 低位在前 高位在后

GAP 通用访问协议(Generic Access Profile)

一共有四种角色：
    Broadcaster ，Observer，Peripheral ，Central

    Broadcaster 广播者:发出广播信号，可以没有无线接收器。
    Observer 观察者: 接收广播信号，可以没有无线发送器。

    Peripheral 外围(周边)设备:可以跟其他设备建立连接，建立连接时它是被动的一方。既含有无线发送器，也含有无线接收器。
    Central 中央(中心)设备:可以跟其他设备建立连接，建立连接时它是主动的一方。既含有无线发送器，也含有无线接收器。

Broadcaster:
    GAP层有4种不同类型的广播：通用的、定向的、不可连接的以及可发现的。

    通用广播：通用广播是用途最广的广播方式。进行通用广播的设备能够被扫描设备扫描到，或者在接收到连接请求时作为从设备进入一个连接。通用广播可以在没有连接的情况下发出，换句话说，没有主从设备之分。

    定向广播：有时候，设备间需要快速建立连接。如果从设备想这么做，就需要进行广播。定向广播事件就是为了尽可能快的建立连接。这种报文包含两个地址：广播者的地址和发起者的地址。发起设备收到发绐自己的定向广播报文后，可以立即发送连接请求作为回应。

    不可连接广播：不想被连接的设备使用不可连接广播事件。这种广播的典型应用包括设备只想广播数据，而不想被扫描或者连接。速也是唯一可用于只有发射机而没有接收机设备的广播类型。不可连接广播设备不会进入连接态，因此，它只能根据主机的要求在广播态和就绪态之间切换。

    可发现广播：最后一种广播事件是可发现广播。这种广播不能用于发起连接，但允许其他设备扫描该广播设备。这意味着该设备可以被发现，既可以广播数据，又可以响应扫描，但不能建立连接。这是一种适用于广播数据的广播形式，动态数据可以包含于广播数据之中，而静态数据可以包含于扫描响应数据之中。可发现广播不会进入连接态，而只能在停止后回到就绪态。



Android 应用层开发中支持广播类型:可连接 、不可连接(iBeacon,室内定位)
                  不支持广播类型: 定向广播



Connection Interval  (主从设备连接间隔)    最小7.5ms 最大4.0s

    Slave Latency  （从设备延迟）： 忽略主设备的应答 继续处于睡眠状态

    Supervision Timeout （检测时间超时） ： 最大可连接时间。


Generic Attribute Profile (GATT)
 两个角色：

    GATT Client  ：在GATT服务端读/ 写数据

    GATT Server  :  数据被GATT 客户端读写


Notification与Indication的区别性能


GATT_Indication：从机通知主机后，主机须要调用simpleprofile_writeattrcb,读取从机的数据。也就是说整个过程须要主机响应回复，不然通信失败！主机和从机经过Handle Value Confirmation 进行确认！spa



GATT_Notification：从机直接发送给主机。不须要主机回复，有可能数据丢失！


在典型的BLE系统中，外设发送广播数据，中央设备扫描广播，确认可以连接的目标设备，广播中可以包括设备地址以及一些额外数据，如：设备名称、服务列表等。中央设备接收到广播数据后，会向外设发送扫描请求Scan Request，然后外设将特定的数据回应给中央设备，这个过程称之为Scan Response。中央设备收到扫描回应之后，便知道这是一个可以建立连接的外部设备。以上是设备发现的全过程。然后，中央设备可以向外设发起建立连接的请求。连接请求包括下面一些参数：

连接间隔 ----在两个BLE设备的连接中使用调频机制，两个设备使用特定的信道收发数据，然后过一段时间后再使用新的信道收发数据。这些信道切换是由链路层来处理的。两个设备在信道切换后收发数据称之为连接事件，即使没有应用数据的收发，两个设备依然会通过交换链路层数据来维持连接，连接间隔就是两个连接时间之间的时间间隔，连接间隔以1.25ms为单位，连接间隔的值为6（7.5ms）~3200（4s）。
这个参数的实际意义是：长的时间间隔能够显著的节省功耗（设备可以休眠），但是同时意味着数据传输波特率低；短的时间间隔能够更快的收发数据，同时，功耗也高（因为被频繁的唤醒，没有更多的时间来休眠）。
从机延时----这个参数的设置可以使外设跳过若干连接时间。这使外设有更多的灵活度，如果它没有数据要发送时，可以选择跳过连接事件继续休眠，降低功耗。
管理超时----这个是成功连接事件之间的最大允许的间隔，如果超过了这个时间而没有成功的连接，设备被认为丢失连接，返回到未连接状态，这个值的单位是10ms，管理超时的范围是10（100ms）~3200（32s）,另外，超时值必须大于有效的连接间隔[有效的连接间隔=连接间隔*（1+外设延时）]



RSSI（接收信号强度）Received Signal Strength Indicator

Rss=10logP,
只需将接受到的信号功率P代入就是接收信号强度（灵敏度）。
[例1] 如果发射功率P为1mw，折算为dBm后为0dBm。
[例2] 对于40W的功率，按dBm单位进行折算后的值应为：
10lg（40W/1mw)=10lg（40000）=10lg4+10lg10+10lg1000=46dBm。


Rssi和接收功率有关，单位是dBm
一般为负值，反应的是信号的衰减程度，理想状态下（无衰减），Rssi = 0dBm，实际情况是，即使蓝牙设备挨得非常近，Rssi也只有-50dBm的强度，在传输过程中，不可避免要损耗。
一般情况下，经典蓝牙强度
-50 ~ 0dBm 信号强
-70 ~-50dBm 信号中
<-70dBm 信号弱

低功耗蓝牙分四级
-60 ~ 0 4
-70 ~ -60 3
-80 ~ -70 2
<-80 1
